<!DOCTYPE html>
<html>
    <head>
      
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Sequel to Pandas &middot; Nelson Gonzabato</title>
        <meta name="description" content="sql-to-pandas">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.98.0" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="apple-touch-icon" sizes="180x180" href="../../../../apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="../../../../favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="../../../../favicon-16x16.png">
        <link rel="manifest" href="../../../../site.webmanifest">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">
        
        <link rel="stylesheet" disabled id="dark-mode-theme" href="../../../../dist/darkmode.css">
        <link rel="stylesheet" href="../../../../dist/site.css">
        <link rel="stylesheet" href="../../../../dist/syntax.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        
        <head>
  
  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai-sublime.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

</head>
        
        
        
    </head>
    <body>
        
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B3BZWLHV7B"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-B3BZWLHV7B', { 'anonymize_ip': false });
}
</script>


        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <a class="site-logo" title="" href="">
                                <img src="#ZgotmplZ" alt="" />
                            </a>
                        
                        <a class="button-square" href="../../../../index.xml"><i class="fa fa-rss"></i></a>
                        
                            <a class="button-square button-social hint--top" data-hint="Home" title="Home" href="../../../../" rel="me">
                             <i class="fa fa-home"></i>  
                            </a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Twitter" title="Twitter" href="https://twitter.com/bionelsongon" rel="me">
                                <i class="fab fa-twitter"></i>
                            </a>
                        
                        
                        
                  
                        
                            <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/Nelson-Gon" rel="me">
                                <i class="fab fa-github"></i>
                            </a>
                        
                         
                            <a class="button-square button-social hint--top" data-hint="Stack Overflow" title="Stack Overflow" href="https://stackoverflow.com/users/10323798/nelsongon" rel="me">
                                <i class="fab fa-stack-overflow"></i>
                            </a>
                        
                              
                       
                            
       <link href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" rel="stylesheet">
      <a class="button-square button-social hint--top" data-hint="kaggle" title="Kaggle" href="https://Kaggle.com/gonnel" rel="me">
<i class="fab fa-kaggle"></i>
                   
                    
                      
                        
                        
                            <a  class="button-square button-social hint--top" data-hint="Email" title="Email" href="mailto:gonzabato@hotmail.com">
                                <i class="fa fa-envelope"></i>
                            </a>
                        
                        
                         
                         
                       
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Blog" href="../../../../">Blog</a>
    </li>

    <li class="site-nav-item">
        <a title="About" href="../../../../about/">About</a>
    </li>

    <li class="site-nav-item">
        <a title="Projects" href="../../../../projects/">Projects</a>
    </li>

    <li class="site-nav-item">
        <a title="Contact" href="../../../../social">Contact</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="https://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Sequel to Pandas</h1>
    
        <p class="post-description" itemprop="description">sql-to-pandas</p>
    
    <p class="post-date post-line">
        <span>Published <time datetime="2022-03-05" itemprop="datePublished">Sat, Mar 5, 2022</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="#" itemprop="url" rel="author">Nelson Gonzabato</a>
            </span>
        </span>
    </p>
    
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    <p>One of the most important parts of the data analysis pipeline is the ability to collate data obtained from different sources. While the CSV file format remains the most popular form of data input, a lot of times production level data analysis requires that one fetch data from an internet source which in the simplest form may involve downloading a CSV file from a remote source. Often, however, the data fetch process requires interaction with a database which therefore necessitates that one have an understanding of relational databases and how to interact with them.</p>
<p>For this reason, I have spent the past week or two (at the time of this post) to improving my knowledge of relational databases, and more specifically finally learning SQL. <a href="https://en.wikipedia.org/wiki/SQL">SQL</a> has its origins at IBM where the motivation was to <a href="https://en.wikipedia.org/wiki/SQL">&ldquo;manipulate and retrieve data stored in IBM&rsquo;s original quasirelational database management system&rdquo;</a>. Over the years, the language has grown to be extremely useful and powerful with several different variants now available that differ in syntax and a few other aspects.</p>
<p>With the importance of SQL highlighted, it is time to take a look at how one can run SQL queries within python and finally converting the retrieved data to the familiar <code>DataFrame</code> format.</p>
<p><strong>Required Libraries</strong></p>
<p>This blog post uses <code>sqlite3</code>, the <code>python</code> SQL interface that comes with the standard lib and <code>pandas</code> (1.3.4), the most popular data analysis library. First, we import these as required</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlite3
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd 
</span></span></code></pre></div><p><strong>Define helper functions</strong></p>
<p>Next, to ease our SQL query handling, we define two helper functions, one to create a SQL table and one to execute our sQL queries. These are defined next below</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_connection</span>(db_path<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>): 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        conn <span style="color:#f92672">=</span> sqlite3<span style="color:#f92672">.</span>connect(db_path)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> conn
</span></span></code></pre></div><p>The above function simply creates a SQL connection to a database via the <code>connect</code> method from <code>sqlite3</code>. We use a <code>try-else-finally</code> to ensure that we can raise errors whenever they occur and return a connection once successful.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute_sql</span>(conn, sql_command):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        cursor <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>cursor()
</span></span><span style="display:flex;"><span>        cursor<span style="color:#f92672">.</span>execute(sql_command)
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> cursor<span style="color:#f92672">.</span>fetchall()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> res
</span></span></code></pre></div><p>The <code>execute_sql</code> function briefly takes a <code>sqlite3</code> <a href="https://docs.python.org/3/library/sqlite3.html#sqlite3.Connection">Connection</a> and command as its arguments. The <a href="https://docs.python.org/3/library/sqlite3.html">Cursor</a> object allows us to execute SQL queries via the <code>exceute</code> method. Finally, we use <code>fetchall</code> to fetch all data. We use a <code>try-except-else</code> again as above to ease our error handling.</p>
<p><strong>Run SQL Queries</strong></p>
<p>With our functions in place, we can now run our <code>SQL</code> queries in python. First, we need to create a connection. One thing to note is that the <code>create_connection</code> method requires a path to a database <code>.db</code> file. If the provided path does not exist, one will be created with that name. For purposes of this blog post, we supply a non-existent database name (<code>sample.db</code>) meaning that this will be created for us.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>conn <span style="color:#f92672">=</span> create_connection(<span style="color:#e6db74">&#34;sample.db&#34;</span>)
</span></span></code></pre></div><p>Next, for our table, I chose to create a table with gene id as a primary key and gene expression values.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res <span style="color:#f92672">=</span> execute_sql(conn, <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CREATE TABLE IF NOT EXISTS genes ([gene_id] TEXT PRIMARK KEY,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[gene_expression] NUMERIC)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>)
</span></span></code></pre></div><p>In <code>SQL</code>, to add values to a database, we need to use the <code>INSERT</code> command. While preparing this blog post, I noticed that if one uses the <code>INSERT</code> method, values may be inserted but the user may not see this unless they add a <code>print</code> to the <code>exceute_sql</code> call. However, even then sometimes values would return empty lists despite values being added. For this reason, I use <code>INSERT OR REPLACE INTO</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span> list(map(<span style="color:#66d9ef">lambda</span> gene, value: execute_sql(conn, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;INSERT OR REPLACE INTO genes VALUES (&#39;</span><span style="color:#e6db74">{</span>gene<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;, </span><span style="color:#e6db74">{</span>value<span style="color:#e6db74">}</span><span style="color:#e6db74">)&#34;</span>),
</span></span><span style="display:flex;"><span>               (<span style="color:#e6db74">&#34;RAN1&#34;</span>, <span style="color:#e6db74">&#34;RAN2&#34;</span>, <span style="color:#e6db74">&#34;RAN3&#34;</span>, <span style="color:#e6db74">&#34;RAN4&#34;</span>, <span style="color:#e6db74">&#34;RAN5&#34;</span>, <span style="color:#e6db74">&#34;RAN6&#34;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#ae81ff">0.01</span>, <span style="color:#ae81ff">0.02</span>, <span style="color:#ae81ff">0.03</span>, <span style="color:#ae81ff">0.00001</span>, <span style="color:#ae81ff">0.01</span>, <span style="color:#ae81ff">0.00004</span>)))
</span></span></code></pre></div><p>As one may quickly realize, it can get quickly tiring/boring to have to always manually type out the values to insert. For this blog post, I use a <code>lambda-map</code> approach to semi-automate the insertion process.</p>
<p>With the above, we have successfully created a SQL table with random gene ids and random gene expression values.</p>
<p><strong>SQL to Pandas</strong></p>
<p>Finally, with out pre-sequel in place, it&rsquo;s time to convert this to a pandas <code>DataFrame</code>. We do this by simply calling <code>DataFrame</code> on our result. Here I have used a select within select as I found this really fun to work with and also because if misused it can result in disaster.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pd<span style="color:#f92672">.</span>DataFrame(execute_sql(conn,<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SELECT * FROM genes WHERE gene_expression &lt; (SELECT gene_expression from genes where gene_id = &#39;RAN2&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>) , columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;geneid&#34;</span>, <span style="color:#e6db74">&#34;expression&#34;</span>])
</span></span></code></pre></div><p>This gives us</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ae81ff">0</span>   RAN1     0.01000
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>   RAN4     0.00001
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>   RAN5     0.01000
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>   RAN6     0.00004
</span></span></code></pre></div><p><strong>Outro</strong></p>
<p>As always, this has been a short walk through (mostly for reinforcement of concepts) of how to move from a SQL query to a pandas <code>DataFrame</code>. I hope that this may motivate a reader to use SQL more in their own work. The full notebook used in this code is availabe <a href="https://github.com/Nelson-Gon/nelson-gon.github.io/blob/fce053b641bb9d0de34c63af1ccb13f6da01d9af/code/python_notebooks/explore-sql.ipynb">here</a>.</p>
<p>Thank you for reading</p>
<p>Nelson</p>
<p><strong>Recommended resources</strong></p>
<ul>
<li>
<p><a href="https://docs.python.org/3/library/sqlite3.html">https://docs.python.org/3/library/sqlite3.html</a></p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/">https://www.w3schools.com/sql/</a></p>
</li>
<li>
<p><a href="https://sqlzoo.net/wiki/SQL_Tutorial">https://sqlzoo.net/wiki/SQL_Tutorial</a></p>
</li>
</ul>

</div>

        <footer class="post-footer clearfix">
    
        <p class="post-tags">
            <span>Tagged:</span>
            
            
                <a href="../../../../tags/python/">python</a>, 
            
                <a href="../../../../tags/sql/">sql</a>, 
            
                <a href="../../../../tags/data-analysis/">data-analysis</a>, 
            
                <a href="../../../../tags/open-source/">open-source</a>, 
            
                <a href="../../../../tags/database/">database</a>, 
            
                <a href="../../../../tags/reflection/">reflection</a>
            
        </p>
    

    <div class="share">
        
            <a class="icon-twitter" href="https://twitter.com/share?text=Sequel%20to%20Pandas&url=%2f05%2f03%2f2022%2fsql-to-python-pandas%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
  <i class="fab fa-twitter"></i>
   <span class="hidden">Twitter</span> 
  </a>
        

        
       
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?href=%2f05%2f03%2f2022%2fsql-to-python-pandas%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <i class="fab fa-facebook"></i>
                
                </a>
        

 
        
            <a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&title=Sequel%20to%20Pandas&url=%2f05%2f03%2f2022%2fsql-to-python-pandas%2f&summary=sql-to-pandas"
               onclick="window.open(this.href, 'linkedin-share', 'width=554,height=481');return false;"><i class="fab fa-linkedin"></i></a>
        
        

    </div>
</footer>

        
    <div class="comments">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "nelsongon" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

    </article>
</div>

            </div>
        </div>
    <footer class="footer">
 
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="Biologically Plausible Programming" href="../../../../">Biologically Plausible Programming</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fas fa-angle-up"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2022 Nelson Gonzabato / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="https://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="../../../../js/jquery-1.11.3.min.js"></script>
        <script src="../../../../js/jquery.fitvids.js"></script>
        <script src="../../../../js/scripts.js"></script>
    </body>
</html>

